# WRITING PLUGINS

## Conventions for creating batch job plugin
Following is recommended but need not be followed:

* All the batch related plugins should reside in "com.affinnova.platform.services.batchJobs" package
* There must be a package for each batch account job under "com.affinnova.platform.services.batchJobs.accounts" package. For eg: if we have a batch account by the name "analytics" then all the resources realted to that batch account should be within "com.affinnova.platform.services.batchJobs.accounts.analytics" package
* Each batch account specific plugin should be placed in their respective package
* The plugin for job should follow this naming convention [ACCOUNT NAME][JOB NAME]Plugin and should implement "BatchJobHandler" interface 

### BatchJobHandler Interface:

BatchJobHandler interface enforces plugins to support certain basic apis.

* __BatchJobRunEntity createTask(BatchJobRunEntity batchJobRunEntity, String user, Boolean asyncMode = true)__.
    Create a new task. Make an api call to azure to create a task under account and job specified in the batchJobRunEntity document
* __BatchJobRunEntity stopTask(BatchJobRunEntity batchJobRunEntity, String user)__.
    Stop a running task.
* __Boolean removeTask(BatchJobRunEntity batchJobRunEntity, String user)__.
    Delete a task and its associated blob files.
* __List<CloudBlockBlob> getTaskFiles(BatchJobRunEntity batchJobRunEntity, String prefix = null, Closure predicate = { return true })__.
    Return blob content used/generated as part of task run.
* __File downloadTask(BatchJobRunEntity batchJobRunEntity, String prefix = null, Closure predicate = { return true })__.
    Download the files used/generated as part of task run.
* __Map getTask(String jobId, String taskId)__.
    Get the latest task information from azure if the task is running.
* __void isActionableEvent(Map event)__.
    Predicate method to check if the event received can be processed by the plugin.
* __void onTaskStateChange(Map event)__.
    Proxy method to forward the event received by a event listener from registered event hub.
* __void onTaskCreateEvent(BatchJobRunEntity batchJobRunEntity, String user)__.
    Handles task create event. Create event is not generated by event hub but rather called as part of call to "createTask"
* __void onTaskStartEvent(Map event, BatchJobRunEntity batchJobRunEntity)__.
    Handles task start event.
* __void onTaskCompleteEvent(Map event, BatchJobRunEntity batchJobRunEntity)__.
    Handles task complete event.
* __void onTaskFailEvent(Map event, BatchJobRunEntity batchJobRunEntity)__.
    Handles task fail event.

### Writing Plugins:
If you are worried that you would have to write the plugin to support all the apis then don't. We have defined a default implementation of the above interface which should make it mush eaiser to create/run/manage batch tasks. Here is a simple example:

```java
/**
* Creating and running a task under batch account "analytics" and job "demo"
*/
class AnalyticsDemoPlugin extends BatchJobHandler {

    String getTaskCommand(BatchJobRunEntity batchJobRunEntity, String user) {
        BatchTaskCommand command = new BatchTaskCommand(command: 'sh myLongRunningTask.sh')
        String finalCommand = command.generate()
        logger.info("Prepared command : ${finalCommand}")
        return finalCommand
    }
    
    File getTaskInputFiles(BatchJobRunEntity batchJobRunTableEntity, String user) {
        File tempDir = File.createTempDir()
        //create all the input files needed for the myLongRunningTask under tempDir
        //those files will be places under "inputs" folder by default
        return tempDir
    }
        
    void onTaskCreateEvent(BatchJobRunEntity batchJobRunEntity, String user){
        super.onTaskCreateEvent(batchJobRunEntity, user)
        //write code that you want to be invoked when task is created
    }
    
    void onTaskStartEvent(Map event, BatchJobRunEntity batchJobRunEntity) {
        super.onTaskStartEvent(event, batchJobRunEntity)
        //write code that you want to be invoked when task is started
    }
        
    void onTaskCompleteEvent(Map event, Map batchJobRunDocument) {
        super.onTaskCompleteEvent(event, batchJobRunEntity)
        //write code that you want to be invoked when task is completed
    }
}
```

### Initializing/Setting up plugins

##### GROOVY
In your bootstrap.groovy initialize the plugins as follows:

```java
class BootStrap {

    def init = { servletContext ->
        BatchJobsConfig batchJobsConfig = getBatchJobsConfig()
        BatchJobsManager.setup(batchJobsConfig, [
            new AnalyticsDemoPlugin()
        ] as Set<BatchJobHandler>)
    }
    
    /**
     * Generates the batch job config instance needed to set up batch events and plugins
     *
     * @return BatchJobsConfig
     * */
    BatchJobsConfig getBatchJobsConfig() {
        def config = grailsApplication.config.batchJobs
        if (config) {
            BatchJobsConfig batchJobsConfig = new BatchJobsConfig(
                clientGroupId: config.clientId,
                batchJobsDbUsername: EncryptionUtil.decrypt(config.db.username),
                batchJobsDbPassword: EncryptionUtil.decrypt(config.db.password),
                batchJobsDbHosts: config.db.hosts,
                batchJobsDbName: config.db.databaseName
            )

            if (config.accounts && config.accounts.keySet().size()) {
                config.accounts.each { String accountId, Map accountConfig ->
                    Boolean encryptedKeys = accountConfig.encryptedKeys
                    batchJobsConfig.batchAccountConfigs << [(accountId): new BatchAccountConfig(
                        accountId: accountId,
                        accountAccessKey: encryptedKeys ? EncryptionUtil.decrypt(accountConfig.accessKey) : accountConfig.accessKey,
                        storageAccessKey: encryptedKeys ? EncryptionUtil.decrypt(accountConfig.storageAccessKey) : accountConfig.storageAccessKey,
                        eventHubNamespace: accountConfig.eventHub.namespace,
                        eventHubSasPolicy: accountConfig.eventHub.sasPolicy,
                        eventHubSasPolicyKey: encryptedKeys ? EncryptionUtil.decrypt(accountConfig.eventHub.sasPolicyKey) : accountConfig.eventHub.sasPolicyKey
                    )]
                }
            }

            return batchJobsConfig
        }
        return null
    }
}
```

### Invoking plugin actions:
You can invoke this task from your service like:

```java
class MyTestService{
    
    Map runTask(User user){
        //this document can contain any information you want but it should atleast contain the accountId, jobId
        AnalyticsDemoPlugin analyticsDemoPlugin = BatchJobsManager.getPlugin('analytics','demo')
        Map referenceKeys = //map of reference keys that you might want to use in your event hooks in the plugin
        List recipients = //email list of people you want to send email out to
        BatchJobRunEntity batchJobRunEntity = plugin.getNewBatchJobRunEntity(referenceKeys, recipients)
        return analyticsDemoPlugin.createTask(batchJobRunEntity, user.username)
    }
    
    File download(){
        String jobId = 'demo'
        String taskId = //id returned when executing runTask method
        BatchJobRunEntity azureBatchJobRun = plugin.batchJobRunService.get(jobId, taskId)
        AnalyticsDemoPlugin analyticsDemoPlugin = BatchJobsManager.getPlugin(azureBatchJobRun)
        return analyticsDemoPlugin.downloadTask(azureBatchJobRun)
    }
}
```